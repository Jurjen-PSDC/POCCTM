<!DOCTYPE html>
<html>
  <head>
	<title> CTM 2.0 Beta </title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8"/> 
	<!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">	
	
		<!-- TimeLine -->
	<script type="text/javascript" src="timeline/timeline.js"></script>
	<link rel="stylesheet" type="text/css" href="timeline/timeline.css">
	<link rel="stylesheet" type="text/css" href="css/ctm.css">

	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script src='http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js'></script>
	
</head>
<body>

<!-- NAVIGATION -->
<div class="navbar">
  <div class="navbar-inner">
    <a class="brand" href="#">CTM 2.0 BETA</a>
    <ul class="nav">
      <li class="active"><a href="/">Home</a></li>
     </ul>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="row-fluid">
	<div class="span1"></div>
	<!-- MAIN APP SPACE -->
		<div class="span11">
		  <div class="btn-group">
		  <button class="btn" onclick="switchViewScale('Day')">Day</button>
		  <button class="btn" onclick="switchViewScale('Week')">Week</button>
		  <button class="btn" onclick="switchViewScale('Month')">Month</button>
		</div>


		<table class="table table-striped">
			<caption>Tasks</caption>
			<thead><tr><th>Name</th><th>Start</th><th>End</th><th>Completed</th><th data-bind="headerTimeLine:$data">T</th></tr></thead>
			<tbody data-bind="template: { name:'project-template', foreach:projects}">
			</tbody>
		</table>
	</div>
	<!-- END MAIN APP SPACE -->
</div>
<!-- END MAIN CONTENT --> 
</body>

<script type="text/html" id="project-template">
	<tr>
		<td data-bind="text:ProjectName"></td>
		<td data-bind="text:StartMoment">Colum1</td>
		<td data-bind="text:EndMoment">Colum2</td>
		<td data-bind="text:Completed"></td>
		<td>	
			<div data-bind="projectTimeLine:$data"> </div>
		</td>
	</tr>
	<!-- ko foreach: Tasks -->
	<tr>
		<td data-bind="text:TaskName"></td>
		<td data-bind="text:StartMoment">Colum1</td>
		<td data-bind="text:EndMoment">Colum2</td>
		<td data-bind="text:Completed"></td>
		<td>	
			<div data-bind="taskTimeLine:$data"></div>
			<!-- <div class='ctm-levermoment-box'><div class='ctm-levermoment'><div class='ctm-levermoment-driehoek'> </div></div></div> -->
		</td>
		
	</tr>
	<!-- /ko -->
</script>

<script type="text/javaScript" src="komodels/koProjectmodel.js"></script> 

<script>

var timelinewidth = "90%";	
var timelineheigth = "80px";	
var timelineHeaderheigth = "40px";
var timelines = new Array();

function updateRanges(start, end){
	for(var i = 0; i < timelines.length; i++){
			timelines[i].setVisibleChartRange(start, end);
	} 
}

/* 
 *
 */
function switchViewScale(Scale){
	alert(Scale);
}

		
$(document).ready(function () {

	ko.bindingHandlers.headerTimeLine = {
		init: function(element, accessor){
					
			var projectModel = accessor();
			var startDate = new Date(projectModel.firstStartDate());
			var endDate = new Date(projectModel.lastEndDate());
					
			// Create the JSON data table
			var data = [
				{
					start: startDate,
					end : endDate,
					content : "",
					className : 'ctm-box-header',
					type : "range",
					'ctmItemType' : 'ctm-header'			
				}
			];

			// specify options
			var options = {
				start : startDate,
				end : endDate,
				width:  timelinewidth,
				height: timelineHeaderheigth,
				editable: false,   // enable dragging and editing events
				style: "range",
				showMajorLabels : false,
				showMinorLabels : false,
				scale: links.Timeline.StepDate.SCALE.DAY,
				step: 1
			};
				
			var timeline = new links.Timeline(element);
			function onRangeChanged(properties) {
					updateRanges(properties.start, properties.end);
			}

			// attach an event listener using the links events handler
			links.events.addListener(timeline, 'rangechange', onRangeChanged);
			timelines.push(timeline);
			// Draw our timeline with the created data and options
			timeline.draw(data, options);
		}
	}
		
		
	ko.bindingHandlers.projectTimeLine = {
		init: function(element, accessor){
			var projectModel = accessor();
			
			// Create the JSON data table
			var data = [
				{
					'start': new Date(projectModel.StartMoment()),
					'end' : new Date(projectModel.EndMoment()),
					'content' : "",
					'className' : 'ctm-box-project',
					'type' : "range",
					'ctmItemType' : 'ctm-project'			
				}
			];

			// specify options
			var options = {
				start : new Date(projectModel.StartMoment()),
				end : new Date(projectModel.EndMoment()),
				width:  timelinewidth,
				height: timelineheigth,
				editable: false,   // enable dragging and editing events
				style: "range",
				showMajorLabels : true,
				showMinorLabels : true,
				scale: links.Timeline.StepDate.SCALE.DAY,
				step: 1
			};
			
			var timeline = new links.Timeline(element);
			function onRangeChanged(properties) {
					updateRanges(properties.start, properties.end);
			}

			// attach an event listener using the links events handler
			links.events.addListener(timeline, 'rangechange', onRangeChanged);
		
			function onChanged(){
				console.log(data[0].start.toLocaleString() + " " + data[0].end.toLocaleString());
				projectModel.StartMoment(data[0].start);
				projectModel.EndMoment(data[0].end);
				
			}

			function onAdded(){
				timeline.cancelAdd();
			}
			
			links.events.addListener(timeline, 'change', onChanged);
			links.events.addListener(timeline, 'add', onAdded);
					
			timelines.push(timeline);
			// Draw our timeline with the created data and options
			timeline.draw(data, options);
		}
	}
		
		
	ko.bindingHandlers.taskTimeLine = {
		init: function(element, accessor, allBindingsAccessor, viewModel, bindingContext){
			var taskModel = accessor();
			var data = [
				{
					'start': new Date(taskModel.StartMoment()),
					'end' : new Date(taskModel.EndMoment()),
					'content' : "taak <span data-taskid=" + taskModel.TaskId + "> </span> ",
					'type' : "range",
					'className' : 'ctm-box',
					'ctmItemType' : 'ctm-task'
				}
			];
			var parent = bindingContext.$parent;
			// specify options
			var options = {
				start : new Date(parent.StartMoment()),
				end : new Date(parent.EndMoment()),
				width:  timelinewidth,
				height: timelineheigth,
				editable: true,   // enable dragging and editing events
				style: "range",
				showMajorLabels : false,
				showMinorLabels : true,
				scale: links.Timeline.StepDate.SCALE.HOUR,
				step: 12
			};
			
			var timeline = new links.Timeline(element);
			
			function onRangeChanged(properties) {
				updateRanges(properties.start, properties.end);
				var $positionNow = $(element).find(".timeline-currenttime").position().left;
				$(element).next().css("left", $positionNow)
		
			}

			// attach an event listener using the links events handler
			links.events.addListener(timeline, 'rangechange', onRangeChanged);
			
			function onChanged(){
				console.log(data[0].start.toLocaleString() + " " + data[0].end.toLocaleString());
				taskModel.StartMoment(data[0].start);
				taskModel.EndMoment(data[0].end);
			}
				
				
			function onAdded(){
				timeline.cancelAdd();
			}
			
			links.events.addListener(timeline, 'change', onChanged);
			links.events.addListener(timeline, 'add', onAdded);
		
				
			timelines.push(timeline);
			// Draw our timeline with the created data and options
			timeline.draw(data, options);
			
			
			var $positionNow = $(element).find(".timeline-currenttime").position().left;
			$(element).next().css("left", $positionNow);
		}
	}		
	
	var initialProjectData = getInitialData(); 
		
	ko.applyBindings(new koProjectsModel(initialProjectData));
});
</script>


</html>